/*
 * Solve parametric convex optimization problem using ADMM
 *
 * Automatically generated on 2014-11-24 17:03:53.165663
 */

#include "admm.h"

// Variable Definitions 
static double x[nPrimal+nEqCon]; // Extra rows are working space for solving KKT system
static double y[nDual];
static double lambda[nDual];
static double prev_lambda[nDual];
static double prev_y[nDual];

static double workDual[nDual];      // Working memory of size dual
static double kktRHS[nPrimal+nEqCon]; // RHS when solving the KKT system
static double r[nDual];             // Dual error
static double s[nPrimal];           // Primal error


// Load required data into static memory
static const double const_l[41] = {5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,5,1,1,1,1,1,1,1,1,4,0,0,0,0,0,0,0,0,0,0,0,0};
static const double pL[82] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
static double l[41];
static const double const_f[19] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
static const double pF[38] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
static double f[19];
static const double const_b[10] = {0,0,0,0,0,0,0,0,0,0};
static const double pB[20] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1};
static double b[10];
#define DUALTOL 0.001
#define PRIMALTOL 0.001
#define ITR_PER_CONV_TEST 10
#define rho 1
#define MAXITR 1000
static const double invK[841] = {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0.05740509965,0.02870254983,0.01406650946,0.02138452964,0.008810552775,0.0007462662955,0.002272247527,0.005168267003,0.05740509965,-0.07204114002,-0.02664048633,-0.007284571543,0,0,0,0,0,0.3800005153,-0.3007602334,-0.1859500341,-0.204429052,-0.09750640383,-0.01811108294,-0.01363348516,-0.03100960202,0.07924028193,0.3800005153,0,0,0.02870254983,0.01435127491,0.007033254729,0.01069226482,0.004405276387,0.0003731331477,0.001136123764,0.002584133502,0.02870254983,-0.03602057001,-0.01332024316,-0.003642285772,0,0,0,0,0,-0.3099997424,0.8496198833,-0.09297501703,-0.102214526,-0.04875320192,-0.009055541468,-0.006816742582,-0.01550480101,0.539620141,-0.3099997424,0,0,0.01406650946,0.007033254729,0.0569901557,0.03201170522,0.01538727876,0.02018286462,0.01299773498,0.00410107456,0.01406650946,0.03589039152,-0.07361458216,-0.0225724084,0,0,0,0,0,-0.09019199972,0.2929160751,0.321049094,-0.3549750559,-0.1949165298,-0.1990835976,-0.07798640991,-0.02460644736,0.2027240754,-0.09019199972,0,0,0.02138452964,0.01069226482,0.03201170522,0.02135198502,0.009896277573,0.01027799889,0.007066929374,0.003342604031,0.02138452964,-6.508924685e-05,-0.04346741266,-0.01310734708,0,0,0,0,0,0.299904129,-0.4287320208,-0.3859629615,0.771405209,-0.1218348659,-0.1040695696,-0.04240157624,-0.02005562419,-0.1288278918,0.299904129,0,0,0.008810552775,0.004405276387,0.01538727876,0.009896277573,0.05873807319,0.03211453719,0.02812827283,0.02737590441,0.008810552775,0.002171449596,0.03345451685,-0.06272433755,0,0,0,0,0,0.1059761421,-0.141467862,-0.1238467564,0.2650651096,0.3145464975,-0.3614568601,-0.168769637,-0.1642554265,-0.03549171988,0.1059761421,0,0,0.0007462662955,0.0003731331477,0.02018286462,0.01027799889,0.03211453719,0.02100970146,0.01702953922,0.01406718747,0.0007462662955,0.01906346518,0.001653673678,-0.03609469943,0,0,0,0,0,-0.1420599933,0.290090117,0.2915826496,-0.4306575777,-0.3792675832,0.7717645559,-0.1021772353,-0.08440312483,0.1480301237,-0.1420599933,0,0,0.002272247527,0.001136123764,0.01299773498,0.007066929374,0.02812827283,0.01702953922,0.1012159259,0.05615732975,0.002272247527,0.009589363694,0.008063608466,0.05605811385,0,0,0,0,0,-0.04490344417,0.1079848686,0.1125293636,-0.1483438177,-0.1130091708,0.2905272093,0.3927044446,-0.3369439785,0.06308142439,-0.04490344417,0,0,0.005168267003,0.002584133502,0.00410107456,0.003342604031,0.02737590441,0.01406718747,0.05615732975,0.03473302335,0.005168267003,-0.003651325945,0.01993222582,0.01471423787,0,0,0,0,0,0.1015663456,-0.1617865552,-0.1514500212,0.2736894348,0.2904024549,-0.4213471033,-0.3369439785,0.7916018599,-0.06022020958,0.1015663456,0,0,0.05740509965,0.02870254983,0.01406650946,0.02138452964,0.008810552775,0.0007462662955,0.002272247527,0.005168267003,0.05740509965,-0.07204114002,-0.02664048633,-0.007284571543,0,0,0,0,0,-0.6199994847,-0.3007602334,-0.1859500341,-0.204429052,-0.09750640383,-0.01811108294,-0.01363348516,-0.03100960202,-0.9207597181,-0.6199994847,0,0,-0.07204114002,-0.03602057001,0.03589039152,-6.508924685e-05,0.002171449596,0.01906346518,0.009589363694,-0.003651325945,-0.07204114002,0.1439521015,-0.03365385267,-0.01164555108,0,0,0,0,0,-0.1601927727,-0.2559435749,-0.4000258549,-0.04833147784,-0.04865692407,-0.1719169732,-0.05753618216,0.02190795567,-0.4161363475,-0.1601927727,0,0,-0.02664048633,-0.01332024316,-0.07361458216,-0.04346741266,0.03345451685,0.001653673678,0.008063608466,0.01993222582,-0.02664048633,-0.03365385267,0.1505365117,-0.02704458207,0,0,0,0,0,-0.1037359872,-0.005651916268,-0.05893288892,-0.1513650435,-0.3687021069,-0.05830369287,-0.0483816508,-0.1195933549,-0.1093879034,-0.1037359872,0,0,-0.007284571543,-0.003642285772,-0.0225724084,-0.01310734708,-0.06272433755,-0.03609469943,0.05605811385,0.01471423787,-0.007284571543,-0.01164555108,-0.02704458207,0.1548771508,0,0,0,0,0,-0.008819592948,-0.04063738645,-0.05520652954,0.01724865042,-0.04828808501,-0.1197804865,-0.3363486831,-0.0882854272,-0.0494569794,-0.008819592948,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0.7647058824,-0.05882352941,-0.4705882353,-0.1176470588,-0.1176470588,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.05882352941,0.2352941176,-0.1176470588,-0.02941176471,-0.02941176471,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.4705882353,-0.1176470588,1.058823529,0.2647058824,0.2647058824,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.1176470588,-0.02941176471,0.2647058824,0.4411764706,-0.05882352941,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-0.1176470588,-0.02941176471,0.2647058824,-0.05882352941,0.4411764706,0,0,0,0,0,0,0,0,0,0,0,0,0.3800005153,-0.3099997424,-0.09019199972,0.299904129,0.1059761421,-0.1420599933,-0.04490344417,0.1015663456,-0.6199994847,-0.1601927727,-0.1037359872,-0.008819592948,0,0,0,0,0,-3.398450605,1.836905332,0.5969063623,-2.475354906,-0.9758342611,1.121780625,0.269420665,-0.6093980736,-1.561545273,-3.398450605,0,0,-0.3007602334,0.8496198833,0.2929160751,-0.4287320208,-0.141467862,0.290090117,0.1079848686,-0.1617865552,-0.3007602334,-0.2559435749,-0.005651916268,-0.04063738645,0,0,0,0,0,1.836905332,-6.07989253,-2.681412997,3.315277395,1.171617292,-2.388449913,-0.6479092113,0.9707193311,-4.242987199,1.836905332,0,0,-0.1859500341,-0.09297501703,0.321049094,-0.3859629615,-0.1238467564,0.2915826496,0.1125293636,-0.1514500212,-0.1859500341,-0.4000258549,-0.05893288892,-0.05520652954,0,0,0,0,0,0.5969063623,-2.681412997,-3.053313065,2.906419291,0.9766044838,-2.424672079,-0.6751761817,0.9087001271,-2.084506635,0.5969063623,0,0,-0.204429052,-0.102214526,-0.3549750559,0.771405209,0.2650651096,-0.4306575777,-0.1483438177,0.2736894348,-0.204429052,-0.04833147784,-0.1513650435,0.01724865042,0,0,0,0,0,-2.475354906,3.315277395,2.906419291,-6.199490405,-2.34246436,3.474008372,0.890062906,-1.642136609,0.8399224896,-2.475354906,0,0,-0.09750640383,-0.04875320192,-0.1949165298,-0.1218348659,0.3145464975,-0.3792675832,-0.1130091708,0.2904024549,-0.09750640383,-0.04865692407,-0.3687021069,-0.04828808501,0,0,0,0,0,-0.9758342611,1.171617292,0.9766044838,-2.34246436,-2.95163869,2.953660524,0.6780550248,-1.74241473,0.1957830304,-0.9758342611,0,0,-0.01811108294,-0.009055541468,-0.1990835976,-0.1040695696,-0.3614568601,0.7717645559,0.2905272093,-0.4213471033,-0.01811108294,-0.1719169732,-0.05830369287,-0.1197804865,0,0,0,0,0,1.121780625,-2.388449913,-2.424672079,3.474008372,2.953660524,-6.373750592,-1.743163256,2.52808262,-1.266669288,1.121780625,0,0,-0.01363348516,-0.006816742582,-0.07798640991,-0.04240157624,-0.168769637,-0.1021772353,0.3927044446,-0.3369439785,-0.01363348516,-0.05753618216,-0.0483816508,-0.3363486831,0,0,0,0,0,0.269420665,-0.6479092113,-0.6751761817,0.890062906,0.6780550248,-1.743163256,-2.356226668,2.021663871,-0.3784885463,0.269420665,0,0,-0.03100960202,-0.01550480101,-0.02460644736,-0.02005562419,-0.1642554265,-0.08440312483,-0.3369439785,0.7916018599,-0.03100960202,0.02190795567,-0.1195933549,-0.0882854272,0,0,0,0,0,-0.6093980736,0.9707193311,0.9087001271,-1.642136609,-1.74241473,2.52808262,2.021663871,-4.74961116,0.3613212575,-0.6093980736,1,0,0.07924028193,0.539620141,0.2027240754,-0.1288278918,-0.03549171988,0.1480301237,0.06308142439,-0.06022020958,-0.9207597181,-0.4161363475,-0.1093879034,-0.0494569794,0,0,0,0,0,-1.561545273,-4.242987199,-2.084506635,0.8399224896,0.1957830304,-1.266669288,-0.3784885463,0.3613212575,-9.804532472,-1.561545273,0,1,0.3800005153,-0.3099997424,-0.09019199972,0.299904129,0.1059761421,-0.1420599933,-0.04490344417,0.1015663456,-0.6199994847,-0.1601927727,-0.1037359872,-0.008819592948,0,0,0,0,0,-3.398450605,1.836905332,0.5969063623,-2.475354906,-0.9758342611,1.121780625,0.269420665,-0.6093980736,-1.561545273,-7.398450605};

// Initialize values of all variables
void zero_vector(double *vec, int len) {for(int i=0; i<len; i++) vec[i]=0.0;}
void initialize()
{
  zero_vector(x, nPrimal);
  zero_vector(y, nDual);
  zero_vector(lambda, nDual);
  zero_vector(prev_lambda, nDual);
  zero_vector(prev_y, nDual);
  zero_vector(workDual, nDual);
}

// Function declaration
void solve(Sol *sol, const double par[2])
{
  double rDual, rPrimal;
  int itr, i;

  l[0] = 0.0;
  l[1] = 0.0;
  l[2] = 0.0;
  l[3] = 0.0;
  l[4] = 0.0;
  l[5] = 0.0;
  l[6] = 0.0;
  l[7] = 0.0;
  l[8] = 0.0;
  l[9] = 0.0;
  l[10] = 0.0;
  l[11] = 0.0;
  l[12] = 0.0;
  l[13] = 0.0;
  l[14] = 0.0;
  l[15] = 0.0;
  l[16] = 0.0;
  l[17] = 0.0;
  l[18] = 0.0;
  l[19] = 0.0;
  l[20] = 0.0;
  l[21] = 0.0;
  l[22] = 0.0;
  l[23] = 0.0;
  l[24] = 0.0;
  l[25] = 0.0;
  l[26] = 0.0;
  l[27] = 0.0;
  l[28] = 0.0;
  l[29] = 0.0;
  l[30] = 0.0;
  l[31] = 0.0;
  l[32] = 0.0;
  l[33] = 0.0;
  l[34] = 0.0;
  l[35] = 0.0;
  l[36] = 0.0;
  l[37] = 0.0;
  l[38] = 0.0;
  l[39] = 0.0;
  l[40] = 0.0;
  forall(41) l[i] += const_l[i];
  f[0] = 0.0;
  f[1] = 0.0;
  f[2] = 0.0;
  f[3] = 0.0;
  f[4] = 0.0;
  f[5] = 0.0;
  f[6] = 0.0;
  f[7] = 0.0;
  f[8] = 0.0;
  f[9] = 0.0;
  f[10] = 0.0;
  f[11] = 0.0;
  f[12] = 0.0;
  f[13] = 0.0;
  f[14] = 0.0;
  f[15] = 0.0;
  f[16] = 0.0;
  f[17] = 0.0;
  f[18] = 0.0;
  forall(19) f[i] += const_f[i];
  b[0] = 0.0;
  b[1] = 0.0;
  b[2] = 0.0;
  b[3] = 0.0;
  b[4] = 0.0;
  b[5] = 0.0;
  b[6] = 0.0;
  b[7] = 0.0;
  b[8] = +par[0];
  b[9] = +par[1];
  forall(10) b[i] += const_b[i];

  // Set kktRHS[nPrimal+1:end] = pB*par + b
  copy_vector(kktRHS+nPrimal, b, nEqCon);

  // print_vector("b", b, nEqCon);
  // print_vector("kktRHS", kktRHS, nPrimal+nEqCon);

	for(itr=0; itr<MAXITR; itr++) 
	{
    copy_vector(prev_lambda, lambda, nDual);
    copy_vector(prev_y, y, nDual);

    // Compute workDual = rho*(-l + y - lambda)
    forall(nDual) workDual[i] = rho*(-l[i] + y[i] - lambda[i]);

    // kktRHS[1:nPrimal] = L'*workDual
    kktRHS[0] = +workDual[0]+-1*workDual[10];
    kktRHS[1] = +workDual[1]+-1*workDual[11];
    kktRHS[2] = +workDual[2]+-1*workDual[12];
    kktRHS[3] = +workDual[3]+-1*workDual[13];
    kktRHS[4] = +workDual[4]+-1*workDual[14]+workDual[39];
    kktRHS[5] = +workDual[5]+-1*workDual[15]+workDual[40];
    kktRHS[6] = +workDual[6]+-1*workDual[16]+-1*workDual[29]+workDual[31];
    kktRHS[7] = +workDual[7]+-1*workDual[17]+-1*workDual[30]+workDual[32];
    kktRHS[8] = +workDual[8]+-1*workDual[18]+-1*workDual[34]+workDual[35];
    kktRHS[9] = +workDual[9]+-1*workDual[19]+-1*workDual[36]+workDual[37];
    kktRHS[10] = +workDual[20]+-1*workDual[24];
    kktRHS[11] = +workDual[21]+-1*workDual[25];
    kktRHS[12] = +workDual[22]+-1*workDual[26];
    kktRHS[13] = +workDual[23]+-1*workDual[27];
    kktRHS[14] = +-1*workDual[28]+workDual[38];
    kktRHS[15] = +-1*workDual[28]+workDual[29]+workDual[30]+workDual[31]+workDual[32];
    kktRHS[16] = +-1*workDual[28]+workDual[33];
    kktRHS[17] = +-1*workDual[33]+workDual[34]+workDual[35];
    kktRHS[18] = +-1*workDual[33]+workDual[36]+workDual[37];

    // print_vector("workDual", workDual, nDual);
    // print_vector("kktRHS", kktRHS, nPrimal+nEqCon);


    forall(nPrimal) kktRHS[i] -= f[i];

    // Solve the KKT system
    // Solve using dense mat-vec product, since we pre-inverted the KKT matrix
    matvec_product(invK, kktRHS, x, nPrimal+nEqCon, nPrimal+nEqCon);

    // print_vector("x", x, nPrimal+nEqCon);

    // workDual = L*x
    workDual[0] = +x[0];
    workDual[1] = +x[1];
    workDual[2] = +x[2];
    workDual[3] = +x[3];
    workDual[4] = +x[4];
    workDual[5] = +x[5];
    workDual[6] = +x[6];
    workDual[7] = +x[7];
    workDual[8] = +x[8];
    workDual[9] = +x[9];
    workDual[10] = +-1*x[0];
    workDual[11] = +-1*x[1];
    workDual[12] = +-1*x[2];
    workDual[13] = +-1*x[3];
    workDual[14] = +-1*x[4];
    workDual[15] = +-1*x[5];
    workDual[16] = +-1*x[6];
    workDual[17] = +-1*x[7];
    workDual[18] = +-1*x[8];
    workDual[19] = +-1*x[9];
    workDual[20] = +x[10];
    workDual[21] = +x[11];
    workDual[22] = +x[12];
    workDual[23] = +x[13];
    workDual[24] = +-1*x[10];
    workDual[25] = +-1*x[11];
    workDual[26] = +-1*x[12];
    workDual[27] = +-1*x[13];
    workDual[28] = +-1*x[14]+-1*x[15]+-1*x[16];
    workDual[29] = +-1*x[6]+x[15];
    workDual[30] = +-1*x[7]+x[15];
    workDual[31] = +x[6]+x[15];
    workDual[32] = +x[7]+x[15];
    workDual[33] = +x[16]+-1*x[17]+-1*x[18];
    workDual[34] = +-1*x[8]+x[17];
    workDual[35] = +x[8]+x[17];
    workDual[36] = +-1*x[9]+x[18];
    workDual[37] = +x[9]+x[18];
    workDual[38] = +x[14];
    workDual[39] = +x[4];
    workDual[40] = +x[5];

    // workDual = lambda + workDual + l
    forall(nDual) workDual[i] = lambda[i] + workDual[i] + l[i];

    // Evaluate prox functions y = prox(workDual)
    proj_positive(y+0, workDual+0, 38);
    proj_secondOrderCone(y+38, workDual+38, 3);

    // Dual update
    forall(nDual) lambda[i] = workDual[i] - y[i];

    // Check convergence
    if (itr % ITR_PER_CONV_TEST == 0)
    {
      // Dual tolerance rDual = (lambda-prev_lambda)^2
      forall(nDual) r[i] = lambda[i] - prev_lambda[i];
      rDual = sum_squared(r,nDual);

      if (rDual < DUALTOL*DUALTOL) 
      {
        forall(nDual) workDual[i] = y[i] - prev_y[i];
        s[0] = +workDual[0]+-1*workDual[10];
        s[1] = +workDual[1]+-1*workDual[11];
        s[2] = +workDual[2]+-1*workDual[12];
        s[3] = +workDual[3]+-1*workDual[13];
        s[4] = +workDual[4]+-1*workDual[14]+workDual[39];
        s[5] = +workDual[5]+-1*workDual[15]+workDual[40];
        s[6] = +workDual[6]+-1*workDual[16]+-1*workDual[29]+workDual[31];
        s[7] = +workDual[7]+-1*workDual[17]+-1*workDual[30]+workDual[32];
        s[8] = +workDual[8]+-1*workDual[18]+-1*workDual[34]+workDual[35];
        s[9] = +workDual[9]+-1*workDual[19]+-1*workDual[36]+workDual[37];
        s[10] = +workDual[20]+-1*workDual[24];
        s[11] = +workDual[21]+-1*workDual[25];
        s[12] = +workDual[22]+-1*workDual[26];
        s[13] = +workDual[23]+-1*workDual[27];
        s[14] = +-1*workDual[28]+workDual[38];
        s[15] = +-1*workDual[28]+workDual[29]+workDual[30]+workDual[31]+workDual[32];
        s[16] = +-1*workDual[28]+workDual[33];
        s[17] = +-1*workDual[33]+workDual[34]+workDual[35];
        s[18] = +-1*workDual[33]+workDual[36]+workDual[37];
        forall(nPrimal) s[i] *= -rho;
        rPrimal = sum_squared(s,nPrimal);

        if (rPrimal < PRIMALTOL*PRIMALTOL)
          break;
      }
    }
	}

  // Copy to solution structure
  copy_vector(sol->primal, x, nPrimal);
  copy_vector(sol->dual, lambda, nDual);
  sol->itr = itr;
  sol->rDual = rDual;
  sol->rPrimal = rPrimal;
}